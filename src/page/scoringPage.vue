<template>
    <div style="position: fixed; overflow: hidden; width: 100%; height: 100%;">
        <div class="body-style">
            <div class="menu">
                <div class="menu-header" style="display: flex;">
                    <div class="menu-content" style="margin-right: 0; justify-content: space-between;">
                        <div class="progressBar">
                            <div v-for="i in progressBarLength" :key="i"
                                :class="progressBarCount[i - 1] == progressBarList[i - 1] ? 'progressBar-item' : 'progressBar-item-empty'"
                                @click="toggleProgressModal((i - 1))">
                            </div>
                        </div>
                        <div>
                            <button class=" signup-btn-style" style="margin-right: 10px;"
                                @click="toggleHelpModal()">Help</button>
                            <a href="/label/" style="margin-right: 10px;">
                                <button class="signup-btn-style">Home</button>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-wrap" v-show="progressModal"> <!--진행상황-->
            <div class="modal-container">
                <h3>Progress</h3>
                <div style="display: flex; flex-wrap: wrap;">
                    <div v-for="i in progressBarList[progressModalPage]" :key="i"><button
                            style="margin: 2px; width: 40px; height: 30px; font-size: large; padding-top: 1px; display: flex; justify-content: center;"
                            :class="userScoringList[(progressModalPage * 100) + (i - 1)] > 0 ? 'clicked-btn-style' : 'btn-style'"
                            @click="changePage(i)">{{ (progressModalPage * 100) + (i - 1) }}</button></div>
                </div>
                <div class="btncontainer">
                    <button class="btn-style" @click="toggleProgressModal()">Close</button>
                </div>
            </div>
        </div>
        <div class="modal-wrap" v-show="openModal"> <!--사용법-->
            <div class="modal-container">
                <h3>{{ modalTitle[modalPage] }}</h3>
                <div :class="modalPage >= 1 ? 'exampleScore' : ''">
                    <div v-for="i in modalContent[modalPage]" :key="i">
                        <div v-if="modalPage < 1">
                            <p>{{ i }}</p>
                        </div>
                        <div v-else-if="modalPage >= 1">
                            <video autoplay loop :src="videoSrc[modalPage]" style="width: 80%; min-height: 400px;"></video>
                            <p>{{ i }}</p>
                        </div>
                    </div>
                </div>
                <div class="btncontainer">
                    <button class="btn-style" @click="changeModal(0)">&lt;</button>
                    <button class="btn-style" @click="toggleHelpModal()">Close</button>
                    <button class="btn-style" @click="changeModal(1)">></button>
                </div>
            </div>
        </div>
        <div class="home-main-content" style="padding-bottom: 0; padding-top: 10px; margin-bottom: 8px;">
            <p style="font-size: 24px; margin-top: 10px; margin-bottom:4px">Video Ghosting Artifact Scoring System</p>
            <div style="display: flex;">
                <div style="font-size: 20px; margin-left: auto; margin-right: 10px;">
                    {{ currentPageIndex }}/{{ totalLength }}
                </div>
                <div style="margin-right: auto; margin-top: auto; margin-bottom: auto;" class="toggle-switch"
                    :class="{ 'active': isToggled }" @click="toggleVideo">
                    <div class="toggle-button" :style="{ left: isToggled ? '24px' : '0px' }"></div>
                </div>
            </div>
            <!-- <div>currentPage: {{this.currentPage}}</div>    
            <div>videoNameIndex {{this.videoNameIndex}} </div> -->

            <!-- 현재 시간 / 총 시간 -->
            <div>
                <div>{{ this.videoCurrentTime }} / {{ this.videoDuration }}</div>
            </div>
            <div class="video-container">
                <div class="videoPlayer">
                    <div id="video-margin" style="display: flex; max-height: 60%;">
                        <div style="margin: 15px;">
                            <div id="left-video-cover">
                                <!-- toggle된 video -->
                                <div v-show="isToggled" style="position: relative;">
                                    <div style=" overflow: hidden;" class="video-cover">
                                        <video id="toggleVideo" :style="videoStyles" style="position: absolute;"
                                            class="video-style" ref="toggleVideo" controlsList="nodownload" key="videoDiff"
                                            :src="rightArtifactVideo()" @wheel="handleWheel" @click="setZoomCenter"
                                            @mousedown="handleDragStart" @mouseup="handleDragEnd"
                                            @mousemove="handleDragging" onChange="isVideoPaused" preload="auto">
                                        </video>
                                    </div>
                                </div>
                                <div style="display: flex;">
                                    <video id="videoNoartifact" :style="videoStyles" class="video-style"
                                        ref="videoNoartifact" controlsList="nodownload" key="videoNoartifact"
                                        :src="leftOriginalVideo()" @wheel="handleWheel" @click="setZoomCenter"
                                        @mousedown="handleDragStart" @mouseup="handleDragEnd" @mousemove="handleDragging"
                                        onChange="isVideoPaused" preload="auto">
                                    </video>
                                </div>
                            </div>
                            <div>
                                <div style="margin-top: 8px; font-size: 14px; ">{{
                                    this.originalVideoNameList[videoNameIndex] }}
                                </div>
                            </div>
                        </div>
                        <div style="margin: 15px;">
                            <div id="right-video-cover">
                                <video id="videoYesartifact" :style="videoStyles" :class="video - style" class="video-style"
                                    ref="videoYesartifact" controlsList="nodownload" key="videoYesartifact"
                                    :src="rightArtifactVideo()" @wheel="handleWheel" @click="setZoomCenter"
                                    @mousedown="handleDragStart" @mouseup="handleDragEnd" @mousemove="handleDragging"
                                    onChange="isVideoPaused" preload="auto">
                                </video>
                            </div>
                            <div>
                                <div style="margin-top: 8px; font-size: 14px;">{{
                                    this.artifactVideoNameList[videoNameIndex] }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="scoring-button">
                <div style="margin-bottom: 0px;">
                    <button class="btn-style" style="padding-bottom: 6px; padding-top: 6px;" @click="goToBegin">
                        <img style="width: 30px; height: 30px;"
                            src="../images/play_icon/iconmonstr-media-control-52-240.png">
                    </button>
                    <button @click="seekBackward" @mouseover="isMouseOverMinus = true" @mouseout="isMouseOverMinus = false"
                        :class="{ 'btn-style': !isMouseOverMinus, 'clicked-btn-style': isMouseOverMinus }"
                        style="margin-right: 4px; paddinasdg-bottom: 6px; padding-top: 6px;">
                        <img class="icon-style" src="../images/play_icon/iconmonstr-media-control-18-240.png"
                            alt="-1 frame">
                    </button>
                    <button id="videoButton" key="videoButton" @click="changeVideoButton(); changeImgSource()"
                        @mouseover="isMouseOverPlay = true" @mouseout="isMouseOverPlay = false"
                        :class="{ 'btn-style': !isMouseOverPlay, 'clicked-btn-style': isMouseOverPlay }"
                        style="padding-bottom: 6px; padding-top: 6px;">
                        <img class="icon-style" :src=imgSrc>
                    </button>
                    <button @click="seekForward" @mouseover="isMouseOverPlus = true" @mouseout="isMouseOverPlus = false"
                        :class="{ 'btn-style': !isMouseOverPlus, 'clicked-btn-style': isMouseOverPlus }"
                        style="margin-left: 4px; padding-bottom: 6px; padding-top: 6px;s">
                        <img class="icon-style" src="../images/play_icon/iconmonstr-media-control-13-240.png"
                            alt="+1 frame">
                    </button>
                    <button class="btn-style" @click="goToEnd" style="padding-bottom: 6px; padding-top: 6px;">
                        <img class="icon-style" src="../images/play_icon/iconmonstr-media-control-53-240.png">
                    </button>
                </div>
                <div style="display: flex; margin-left: auto; margin-right: auto; margin-bottom: 10px;">
                    <div style="margin-left: auto; margin-right: auto; display: flex;">
                        <button v-on="click" class="btn-style"
                            style="font-size: x-large; width: 80px; height: 40px; padding-top: 0px;"
                            @click="[changeBackVideo()]">prev</button>
                        <button v-for="  a   in   6  " ref="score" :key="a - 1" v-on:click="clickedButton = a - 1"
                            style="width: 50px; height: 40px; font-size:x-large; padding-top: 1px;"
                            :class="{ 'clicked-btn-style': isPressed[a - 1], 'btn-style': !isPressed[a - 1] }"
                            @click="toggleButton(a - 1)">{{ a - 1 }}</button>
                        <button v-on="click" class="btn-style"
                            style="font-size: x-large; width: 80px; height: 40px; padding-top: 0px;"
                            @click="[changeNextVideo()]">{{ this.nextButtonName }}</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer">
            <p>Copyright © 2023 Pi:Lab, SMU. All rights reserved.</p>
            <p>help@pilab.smu.ac.kr</p>
        </div>
    </div>
</template>

<script>
import axios from 'axios'
export default {
    name: 'scoringPage',
    data() {
        return {
            clickedButton: -1,
            noScore: false,
            userScoring: 0,
            scoreNum: [0, 1, 2, 3, 4, 5],
            isPressed: [false, false, false, false, false, false],
            isClicked: false,
            menuBar: ['Home'],
            currentPage: parseInt(this.$route.query.currentPage),
            currentUser: this.$route.query.userName,
            testCode: this.$route.query.testcode,
            videoButtonText: "Stop",
            baseUrl: process.env.BASE_URL + "api/",
            leftVideoUrl: "",
            rightVideoUrl: "",
            isMouseOverMinus: false,
            isMouseOverPlus: false,
            isMouseOverPlay: false,
            videoIndexString: "",
            videoIndex: [],
            zoom: 1,
            minZoom: 1,
            videoStyles: {},
            zoomCenterX: 50,
            zoomCenterY: 50,
            // video url list
            videoList: [],
            originalVideoNameList: [],
            artifactVideoNameList: [],
            videoNameIndex: 0,
            originalVideoFrameList: [],
            artifactVideoFrameList: [],
            dragging: false,
            dragStartX: 0,
            dragStartY: 0,
            offsetX: 0,
            offsetY: 0,
            totalLength: 0,
            imgSrc: require("../images/play_icon/iconmonstr-media-control-48-240.png"),
            isToggled: false,
            videoOriginalWidth: 0,
            preloadedNextOriginalVideo: "",
            preloadedNextArtifactVideo: "",
            preloadedPrevOriginalVideo: "",
            preloadedPrevArtifactVideo: "",
            videoCurrentTime: 0.00,
            videoDuration: 0.00,
            // tempVideo: require("./original.mp4"),
            // tempVideo2: require("./denoise.mp4"),
            // progress bar
            // 점수 체크 안한 비디오, 이미지는 -1로 들어오고 최대 Length까지 전부 들어옴 
            userScoringList: [],
            progressBarList: [],
            progressBarCount: [], //progress bar 내용의 한 거 개수
            progressBarLength: 0,
            progressModalPage: 0,
            modalPage: 0,
            progressModal: false,
            openModal: true,
            modalTitle: ["How To Use", "Example 1", "Example 2"],
            modalContent: [["1. Use the arrow keys to move next or prev video.", "2. Use the number keys to score the video.", "3. Use the mouse wheel to zoom in or out.", "4. Use the mouse to drag the video."], ["Score 1", "Score 5"], ["Moving", "Artifact"]],
            videoSrc: [require("./original.mp4"), require("./denoise.mp4")],
            nextButtonName: "next",
            currentProgress: 0,
        }
    },
    created() { },
    mounted() {
        this.changeVideoButton();
        this.getVideoIndexCurrentPage();
        this.addEventVideoPlay();
        this.isVideoPaused();
        // this.getVideoCurrentTime();
        document.addEventListener('mousemove', this.handleDragging);
        document.addEventListener('mouseup', this.handleDragEnd);
        window.addEventListener("keydown", this.keydown);
        this.addEventVideoCurrentTime();
        // this.preloadNextVideo();
        this.setProgressBar();
        this.getUserScoringList();
    },
    setup() {
        console.log("setup")
    },
    computed: {
        currentPageIndex() {
            return parseInt(this.videoNameIndex) + 1;
        },
    },
    methods: {
        getUserScoringList() {
            console.log("getUserScoringList")
            axios
                .get(this.baseUrl + "getuserScoringList", {
                    params: {
                        userID: this.currentUser,
                        testcode: this.testCode,
                    }
                })
                .then((response) => {
                    this.userScoringList = response.data.userScoringList;
                    console.log("userScoringList" + response.data.userScoringList);
                })
                .catch((error) => {
                    console.log(error);
                })
        },
        checkProgressBar() {
            for (let i = 0; i < this.progressBarLength; i++) {
                for (let j = 0; j < this.progressBarList[i]; j++) {
                    if (this.userScoringList[(i * 100) + j] != -1) this.progressBarCount[i]++;
                }
            }
        },
        toggleHelpModal() {
            console.log(this.openModal)
            this.openModal = !this.openModal;
        },

        toggleProgressModal(index) {
            console.log(this.progressBarList[index]);
            this.progressModal = !this.progressModal;
            this.progressModalPage = index;
        },
        changeModal(flag) {
            if (flag === 0) {
                if (this.modalPage === 0) {
                    this.modalPage = this.modalTitle.length - 1;
                } else {
                    this.modalPage--;
                }
            } else {
                if (this.modalPage === this.modalTitle.length - 1) {
                    this.modalPage = 0;
                } else {
                    this.modalPage++;
                }
            }
        },
        //진행상황 페이지에서 페이지 이동
        async changePage(index) {
            this.currentPage = this.videoIndex[index - 1];
            console.log("changePage: " + this.currentPage)
            await this.$router.push({
                currentPage: this.currentPage,
                userName: this.currentUser,
                testcode: this.testCode,
            });
            // this.makeImageTemplete();
            this.getVideoIndexCurrentPage();
            this.getUserScoringList();
        },
        setProgressBar() {
            // this.videoIndex.length = 452;
            this.progressBarLength = Math.ceil(this.videoIndex.length / 100);
            // if(this.progressBarLength == 0) {
            //     this.progressBarLength = 1;
            // }
            this.progressBarList = [];
            for (var i = 0; i < this.progressBarLength; i++) {
                if (i == this.progressBarLength - 1) {
                    this.progressBarList.push(this.videoIndex.length % 100);
                    console.log("videoIndex.length % 100: " + this.videoIndex.length % 100);
                } else {
                    this.progressBarList.push(100);
                }
            }
        },
        addEventVideoCurrentTime() {
            var video = document.getElementById('videoNoartifact');
            video.addEventListener("loadeddata", (event) => {
                console.log(event.target.currentTime);
                this.videoCurrentTime = event.target.currentTime.toFixed(2);
                this.videoDuration = event.target.duration.toFixed(2);
            });
            video.addEventListener("timeupdate", (event) => {
                this.videoCurrentTime = event.target.currentTime.toFixed(2);
            })
            // this.videoCurrentTime = video1.currentTime;
            // this.currentTime = video1.currentTime;
            // this.videoDuration = video1.duration;
        },
        async getVideoHeight() {
            var video1 = document.getElementById('videoNoartifact');
            const temp = video1.style.height;
            var video1Height = document.getElementById('left-video-cover');
            var video2Height = document.getElementById('right-video-cover');
            var video3Height = document.getElementById('toggleVideo');
            video1Height.style.height = temp;
            video2Height.style.height = temp;
            video3Height.style.height = temp;

            console.log("video1Height: " + video1Height);
            console.log("video2Height: " + video2Height);
            console.log("video3Height: " + video3Height);
        },
        //키보드 이벤트 함수
        keydown(e) {
            switch (e.key) {
                case 'ArrowLeft':
                    e.preventDefault();
                    this.changeBackVideo();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    this.changeNextVideo();
                    break;
                case '0':
                    this.toggleButton(0);
                    break;
                case '1':
                    this.toggleButton(1);
                    break;
                case '2':
                    this.toggleButton(2);
                    break;
                case '3':
                    this.toggleButton(3);
                    break;
                case '4':
                    this.toggleButton(4);
                    break;
                case '5':
                    this.toggleButton(5);
                    break;
            }
        },
        toggleVideo() {
            this.isToggled = !this.isToggled;
            this.applyVideoOverlay();
        },
        applyVideoOverlay() {
            // artifact video와 original video에 대한 DOM 레퍼런스를 가져옵니다.
            const originalVideo = this.$refs.videoNoartifact;
            const toggleVideo = this.$refs.toggleVideo;
            var originalVideoHeader = document.getElementById('videoNoartifact');
            var originalVideoStyle = window.getComputedStyle(originalVideoHeader);
            const leftMargin = originalVideoStyle.getPropertyValue('margin-left');
            if (this.isToggled) {
                // originalVideo의 위치와 크기를 가져옵니다.
                const rect = originalVideo.getBoundingClientRect();
                // toggleVideo를 originalVideo 위치 위로 배치합니다.
                toggleVideo.style.left = leftMargin;
                // toggleVideo.style.width = rect.width + 'px';
                // toggleVideo.style.height = rect.height + 'px';
                toggleVideo.style.zIndex = 10; // toggleVideo를 위로
                console.log("rect.width: " + rect.width)
                console.log("rect.height: " + rect.height)
                console.log("toggleVideo.style.width: " + toggleVideo.style.width)
                console.log("toggleVideo.style.height: " + toggleVideo.style.height)
            } else {
                // isToggled가 false일 때, toggleVideo를 원래 상태로 되돌립니다.
                toggleVideo.style.zIndex = 0;
            }
        },
        clickExport() {
            axios
                .post(this.baseUrl + 'getCSVFile', {
                    testcode: this.clickedTestcodeBtn
                })
                .then((response) => {
                    console.log(response.data);
                    alert("Exported testcode: " + this.clickedTestcodeBtn);
                })
                .catch((error) => {
                    console.log(error);
                })
        },
        goToBegin() {
            var video1 = document.getElementById('videoNoartifact');
            var video2 = document.getElementById('videoYesartifact');
            var video3 = document.getElementById('toggleVideo');
            // video1.pause();
            // video2.pause();
            video1.currentTime = 0;
            video2.currentTime = 0;
            video3.currentTime = 0;
            console.log("goToBegin");
            console.log("video1: " + video1.currentTime);
            console.log("video2: " + video2.currentTime);
            console.log("video3: " + video3.currentTime);
        },
        goToEnd() {
            var video1 = document.getElementById('videoNoartifact');
            var video2 = document.getElementById('videoYesartifact');
            var video3 = document.getElementById('toggleVideo');
            const originalFrame = this.originalVideoFrameList[this.videoNameIndex];
            const temp = video1.duration - (1 / originalFrame) * 2;
            // video1.pause();
            // video2.pause();
            video1.currentTime = temp;
            video2.currentTime = temp;
            video3.currentTime = temp;
            console.log("goToEnd");
            console.log("video1: " + video1.currentTime);
            console.log("video2: " + video2.currentTime);
            console.log("video3: " + video3.currentTime);
        },
        changeImgSource() {
            if (this.videoButtonText != "Play") {
                this.imgSrc = require("../images/play_icon/iconmonstr-media-control-5-240.png")
            } else {
                this.imgSrc = require("../images/play_icon/iconmonstr-media-control-48-240.png")
            }
        },
        isVideoPaused() {
            var video1 = document.getElementById('videoNoartifact');
            var video2 = document.getElementById('videoYesartifact');
            var toggleVideo = document.getElementById('toggleVideo');
            // 비디오가 end 되면 실행
            const pauseAndPlayVideo = () => {
                // this.videoButtonText = "Play";
                if (video1.currentTime < video2.currentTime) {
                    video1.pause();
                    video2.pause();
                    toggleVideo.pause();
                    video1.currentTime = 0;
                    video2.currentTime = 0;
                    toggleVideo.currentTime = 0;
                    this.changeImgSource();
                } else {
                    video1.pause();
                    video2.pause();
                    toggleVideo.pause();
                    video1.currentTime = 0;
                    video2.currentTime = 0;
                    toggleVideo.currentTime = 0;
                    this.changeImgSource();
                }
            };
            video1.addEventListener("ended", pauseAndPlayVideo());
            video2.addEventListener("ended", pauseAndPlayVideo());
        },
        zoomIn() {
            this.zoom += 0.1;
            this.updateVideoStyle();
        },
        zoomOut() {
            if (this.zoom >= this.minZoom + 0.1) {
                this.zoom -= 0.1;
                this.updateVideoStyle();
            }
        },
        setZoomCenter() {
            // 가운데를 기준으로 줌 센터를 고정합니다.
            this.zoomCenterX = 50;
            this.zoomCenterY = 50;
            this.updateVideoStyle();
        },
        handleWheel(event) {
            if (event.deltaY < 0) {
                this.zoomIn();
            } else {
                this.zoomOut();
            }
            // 스크롤 이벤트로 인한 줌 변경 시 항상 가운데를 기준으로 설정합니다.
            this.setZoomCenter(event);
            event.preventDefault();
        },
        handleDragStart(event) {
            this.dragging = true;
            this.dragStartX = event.clientX;
            this.dragStartY = event.clientY;
        },
        handleDragging(event) {
            if (this.dragging) {
                // Zoom level에 따라 드래그 속도 조정
                const adjustedX = (event.clientX - this.dragStartX) / this.zoom;
                const adjustedY = (event.clientY - this.dragStartY) / this.zoom;

                this.offsetX += adjustedX;
                this.offsetY += adjustedY;

                // 초기 드래그 위치 업데이트
                this.dragStartX = event.clientX;
                this.dragStartY = event.clientY;

                this.updateVideoStyle();
            }
        },
        handleDragEnd() {
            this.dragging = false;
        },
        updateVideoStyle() {
            const scale = `scale(${this.zoom})`;
            const translate = `translate(${this.offsetX}px, ${this.offsetY}px)`;

            this.videoStyles = {
                transform: `${scale} ${translate}`,
                transformOrigin: `${this.zoomCenterX}% ${this.zoomCenterY}%`,
            }
        },
        resetZoomAndOffset() {
            this.zoom = this.minZoom;
            this.offsetX = 0;
            this.offsetY = 0;
        },
        // json 받아오는 형식
        // resData := map[string]string{
        // 	"currentPage": currentPage,
        // 	"videoList":   videoList,
        // }
        async getVideoIndexCurrentPage() {
            console.log("getVideoIndexCurrentPage")
            var temp = String(this.currentPage)
            await axios
                .post(this.baseUrl + "getVideoIndexCurrentPage", {
                    userID: this.currentUser,
                    testcode: this.testCode,
                    currentPage: temp,
                })
                .then((response) => {
                    // this.currentPage = parseInt(response.data.currentPage); //여기다 1 더해서 
                    console.log("response current page: ", this.currentPage);
                    this.videoIndex = response.data.videoList;
                    this.totalLength = this.videoIndex.length;
                    this.originalVideoNameList = response.data.originalVideoNameList;
                    this.artifactVideoNameList = response.data.artifactVideoNameList;
                    this.originalVideoFrameList = response.data.originalVideoFPSList;
                    this.artifactVideoFrameList = response.data.artifactVideoFPSList;
                    var curScore = response.data.userScore;

                    for (var i = 0; i < this.videoIndex.length; i++) {
                        if (this.videoIndex[i] == this.currentPage) {
                            this.videoNameIndex = i;
                            break;
                        }
                    }

                    if (curScore != -1) {
                        this.isPressed[curScore] = true;
                        this.clickedButton = curScore;
                        console.log("curScore: " + curScore)
                    }

                    console.log("video list: ", this.videoIndex)
                    // document.getElementById('videoNoartifact').loadeddata = function () {
                    //     this.videoCurrentTime = 0.00;
                    //     this.videoDuration = 0.00;
                    //     var video1 = document.getElementById('videoNoartifact');
                    //     this.videoCurrentTime = video1.currentTime.toFixed(2);
                    //     this.videoDuration = video1.duration.toFixed(2);
                    //     console.log("videoCurrentTime: " + this.videoCurrentTime);
                    //     console.log("videoDuration: " + this.videoDuration);
                    // };
                    this.setProgressBar();
                })
                .catch((error) => {
                    console.log(error);
                    alert("login failed")
                    this.$router.push(process.env.BASE_URL);
                })
        },
        navigateTo(item) {
            if (item === 'Home') {
                this.$router.push('/');
            }
        },
        leftOriginalVideo() {
            // console.log("leftOriginalVideo: " + this.baseUrl + "postvideo/original/" + this.currentPage)
            return String(this.baseUrl + "postvideo/original/" + this.currentPage)
        },
        rightArtifactVideo() {
            // console.log("rightArtifactVideo: " + this.baseUrl + "postvideo/artifact/" + this.currentPage)
            return String(this.baseUrl + "postvideo/artifact/" + this.currentPage)
        },
        async changeNextVideo() {
            console.log("changeNextVideo")
            if (this.videoButtonText == 'Stop') {
                this.changeVideoButton();
            }
            this.userScoring = this.clickedButton
            console.log("user scoring: ", this.userScoring)
            this.resetZoomAndOffset();
            this.updateVideoStyle();
            var videoEelement1 = document.getElementById('videoNoartifact');
            var videoEelement2 = document.getElementById('videoYesartifact');
            videoEelement1.style.transform = "scale(1)";
            videoEelement2.style.transform = "scale(1)";

            if (this.isToggled) {
                this.toggleVideo()
            }

            if (this.currentPage == this.videoIndex[this.videoIndex.length - 1]) {
                // this.getVideoIndexCurrentPage();
                alert("This is the last page of this test code. Thank you!");
                this.$router.push({
                    path: '/label/scoring',
                    query: {
                        currentPage: this.currentPage,
                        userName: this.currentUser,
                        testcode: this.testCode,
                    }
                })
                this.getVideoIndexCurrentPage();
                return;
            } else {
                // if(this.currentPage == this.videoIndex[this.videoIndex.length - 2]){
                //     this.nextButtonName = "submit"
                // } else{
                //     this.nextButtonName = "next";
                // }

                // this.getVideoIndexCurrentPage();
                this.videoNameIndex += 1
                this.currentPage = this.videoIndex[this.videoNameIndex];
                console.log("videoNameIndex: " + this.videoNameIndex)
                console.log("currentPage: " + this.currentPage)
                this.isPressed = [false, false, false, false, false, false]
                await this.$router.push({
                    path: '/label/scoring',
                    query: {
                        currentPage: this.currentPage,
                        userName: this.currentUser,
                        testcode: this.testCode,
                    }
                })
                // TODO: nex button을 누르면 처음 비디오로 다시 리로딩 되는 버그 발생 -> 임시 주석 처리  
                this.getUserScoringList();
                this.getVideoIndexCurrentPage();
            }
        },
        changeBackVideo() {
            if (this.videoButtonText == 'Stop') {
                this.changeVideoButton();
            }
            this.userScoring = this.clickedButton
            console.log("user scoring: ", this.userScoring)
            this.resetZoomAndOffset();
            this.updateVideoStyle();
            if (this.isToggled) {
                this.toggleVideo()
            }
            var videoEelement1 = document.getElementById('videoNoartifact');
            var videoEelement2 = document.getElementById('videoYesartifact');
            videoEelement1.style.transform = "scale(1)";
            videoEelement2.style.transform = "scale(1)";
            if (this.currentPage == this.videoIndex[0]) {
                alert("This is the first page of this test code.");
                this.$router.push({
                    path: '/label/scoring',
                    query: {
                        currentPage: parseInt(this.currentPage),
                        userName: this.currentUser,
                        testcode: this.testCode,
                    }
                })
                this.getUserScoringList();
                this.getVideoIndexCurrentPage();
                return;
            } else {
                this.videoNameIndex -= 1
                this.currentPage = this.videoIndex[this.videoNameIndex];
                this.isPressed = [false, false, false, false, false, false]
                this.$router.push({
                    path: '/label/scoring',
                    query: {
                        currentPage: this.currentPage,
                        userName: this.currentUser,
                        testcode: this.testCode,
                    }
                })
                this.getVideoIndexCurrentPage();
            }
        },
        // score button 눌렸는지 안눌렸는지 확인하는 method
        toggleButton(index) {
            this.isPressed = [false, false, false, false, false, false]
            this.isPressed[index] = !this.isPressed[index]

            this.userScoring = index
            axios
                .post(this.baseUrl + "postdata", {
                    Title: "scoring data",
                    Score: this.userScoring,
                    CurrentUser: this.currentUser,
                    ImageId: parseInt(this.currentPage),
                    TestCode: this.testCode
                })
                .then(res => {
                    //after post we have to init data form userScoring and currentPage
                    this.userScoring = 0
                    // this.isPressed = [false, false, false, false, false, false]
                    this.resetZoomAndOffset();
                    this.updateVideoStyle();
                    console.log(res.data)
                })
                .catch(error => {
                    console.error(error);
                })
        },
        // video 2개 동시에 플레이 시키는 method
        playVideos() {
            var video1 = document.getElementById('videoNoartifact');
            var video2 = document.getElementById('videoYesartifact');
            // toggleVideo는 videoYesartifact와 같은 비디오 
            var toggleVideo = document.getElementById('toggleVideo');
            const originalFrame = 1 / this.originalVideoFrameList[this.videoNameIndex];
            const artifactFrame = 1 / this.artifactVideoFrameList[this.videoNameIndex];

            if (video1 && video2 && toggleVideo) {
                if (video1.currentTime + originalFrame * 3 >= video1.duration || video2.currentTime + artifactFrame * 3 >= video2.duration
                    || toggleVideo.currentTime + artifactFrame * 3 >= toggleVideo.duration || video1.ended || video2.ended || toggleVideo.ended) {
                    video1.currentTime = 0;
                    video2.currentTime = 0;
                    toggleVideo.currentTime = 0;
                }
                video1.currentTime = video2.currentTime;
                video1.currentTime = video2.currentTime;
                toggleVideo.currentTime = video2.currentTime;
                toggleVideo.currentTime = video2.currentTime;
                // var temp = VideoDecoder()
                // temp.flush();
                video1.play();
            }
        },
        addEventVideoPlay() {
            var video1 = document.getElementById('videoNoartifact');
            var video2 = document.getElementById('videoYesartifact');
            var toggleVideo = document.getElementById('toggleVideo');
            var video2_currentTime = video2.currentTime;
            video1.currentTime = video2_currentTime;
            toggleVideo.currentTime = video2_currentTime;
            video2.currentTime = video2_currentTime;

            video1.addEventListener("play", () => {
                document.getElementById('videoYesartifact').play();
                document.getElementById('toggleVideo').play();
                console.log("play");
                console.log("video1: " + video1.currentTime);
                console.log("video2: " + video2.currentTime);
                console.log("toggle: " + toggleVideo.currentTime);
                console.log("==========================");
            });
            video1.addEventListener("pause", () => {
                document.getElementById('videoYesartifact').pause();
                document.getElementById('toggleVideo').pause();
                var temp = video2.currentTime;
                video1.currentTime = temp;
                toggleVideo.currentTime = temp;
                video2.currentTime = temp;
            })
            video1.addEventListener("ended", () => {
                video1.currentTime = 0;
                video2.currentTime = 0;
                toggleVideo.currentTime = 0;
                video1.play();
            })
        },
        // video 2개 동시에 Stop 시키는 method
        pauseVideos() {
            var video1 = document.getElementById('videoNoartifact');
            var video2 = document.getElementById('videoYesartifact');
            var toggleVideo = document.getElementById('toggleVideo');

            if (video1 && video2 && toggleVideo) {
                var temp = video2.currentTime;
                video1.currentTime = temp;
                toggleVideo.currentTime = temp;
                video1.pause();
            }
        },
        // Play/Stop 및 text 변경 버튼
        async changeVideoButton() {
            if (this.videoButtonText == "Play") {
                this.playVideos();
                this.videoButtonText = "Stop";
            } else {
                this.videoButtonText = "Play";
                this.pauseVideos();
            }
            this.changeImgSource();
        },
        async seekBackward() {
            const video1 = this.$refs.videoNoartifact;
            const video2 = this.$refs.videoYesartifact;
            const video3 = document.getElementById('toggleVideo');
            const originalFrame = 1 / this.originalVideoFrameList[this.videoNameIndex];
            const artifactFrame = 1 / this.artifactVideoFrameList[this.videoNameIndex];
            console.log("originalFrame: " + originalFrame)
            console.log("artifactFrame: " + artifactFrame)

            if (originalFrame != 0 && artifactFrame != 0) {
                // const halfOriginalFrame = (originalFrame) / 2;
                // const halfArtifactFrame = (artifactFrame) / 2;
                if (video1 && video2) {
                    if (video1.currentTime - originalFrame <= 0 || video2.currentTime - artifactFrame <= 0 || video3.currentTime <= 0) {
                        return;
                    }
                    video1.currentTime -= originalFrame;
                    video2.currentTime -= artifactFrame;
                    video3.currentTime -= artifactFrame;
                }
            }
        },
        async seekForward() {
            const video1 = this.$refs.videoNoartifact;
            const video2 = this.$refs.videoYesartifact;
            const video3 = document.getElementById('toggleVideo');
            const originalFrame = 1 / this.originalVideoFrameList[this.videoNameIndex];
            const artifactFrame = 1 / this.artifactVideoFrameList[this.videoNameIndex];
            console.log("originalFrame: " + originalFrame)
            console.log("artifactFrame: " + artifactFrame)

            if (originalFrame != 0 && artifactFrame != 0) {
                const halfOriginalFrame = (originalFrame) / 2;
                const halfArtifactFrame = (artifactFrame) / 2;
                if (video1 && video2) {
                    if (video1.currentTime == 0 || video2.currentTime == 0) {
                        video1.currentTime = halfOriginalFrame + originalFrame;
                        video2.currentTime = halfArtifactFrame + artifactFrame;
                        video3.currentTime = halfArtifactFrame + artifactFrame;
                    } else {
                        // 마지막 프레임을 버림
                        if (video1.currentTime + originalFrame * 3 >= video1.duration || video2.currentTime + artifactFrame * 3 >= video2.duration
                            || video3.currentTime + artifactFrame * 3 >= video3.duration || video1.ended || video2.ended || video3.ended) {
                            return;
                        }
                        video1.currentTime += originalFrame;
                        video2.currentTime += artifactFrame;
                        video3.currentTime += artifactFrame;
                    }
                }
            }
        },
    },
}
</script>

<style>
@import '../main.css';
@import url('https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500&display=swap');
</style>
