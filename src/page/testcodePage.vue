<template>
  <div class="body-style">
    <div class="menu">
      <div class="menu-header" style="display: flex;">
        <div class="menu-content" style="margin-right: 0; justify-content: right;">
          <a href="/label/" style="margin-right: 10px;">
            <button class="signup-btn-style">Home</button>
          </a>
          <a href="/label/admin/main">
            <button class="signup-btn-style">Admin</button>
          </a>
        </div>
      </div>
    </div>
  </div>
  <div class="home-main-content-admin" style="padding-bottom: 0; margin: 0 0 0 0">
    <div>
      <h4>Video Testcode Page</h4>
    </div>
    <div style="display: flex; margin-left: 2vw;">
      <div style="display:inline-block; text-align: left; min-width: 15vw;">
        <h5>
          Admin Index
        </h5>
        <div style="display: inline-block;">
          <div>
            <div>Video</div>
            <div>
              <li><a href="/label/admin/testcode">Video Testcode</a></li>
              <li><a href="/label/admin/upload">Video Upload</a></li>
            </div>
            <div>Image</div>
            <div>
              <li><a href="/label/admin/imagetestcode">Image Testcode</a></li>
              <li><a href="/label/admin/imageupload">Image Upload</a></li>
            </div>
            <div>Frame Selection</div>
            <div>
              <li><a href="/label/admin/inputtestcode">Video Frame Selection</a></li>
            </div>
          </div>
        </div>
      </div>
      <div style="display: inline-block;">
        <div class="wrapping">
          <div class="container">
            <div>
              <h3>Tag</h3>
              <div class="tagWrapper">
                <div>
                  <button @click="selectAllTags(); getVideoListFromTag()" ref="selectAllBtn"
                    :class="{ 'clicked-btn-style': this.isSelectedAll, 'btn-style': !this.isSelectedAll }">All</button>
                  <button v-for="(item, index) in tag" :key="index" ref="tag"
                    :class="{ 'btn-style': !clickedTagBtn.includes(item), 'clicked-btn-style': clickedTagBtn.includes(item) }"
                    @click="clickTagBtn(index); getVideoListFromTag()" @mouseover="mouseOver(index)"
                    @mouseout="mouseOut(index)">
                    {{ item }}
                  </button>
                </div>
              </div>
            </div>
          </div>
          <button @click="generateTestcode" class="btn-style"> TestCode Generation </button>
        </div>
        <div style="width: 800px; max-height: 500px; margin-left: auto; margin-right: auto;">
          <h3 style="margin-top: 10px;">TestCode</h3>
          <div style="display: flex; flex-direction: column;">
            <div style="margin-left: auto; margin-right: auto; display: flex; flex-direction: column;">
              <div style="display: flex; flex-direction: column; gap: 10px;">
                <div v-for="(tagItem, index) in existTestcode.tags" :key="tagItem"
                  style="display: flex; justify-content: space-between;">
                  <div style="margin-top: 10px; margin-left: 1px; margin-right: 1px; display: flex;
                                justify-content: space-between;">
                    <button @click="clickTestcodeBtn(existTestcode.testcode[index])"
                      :class="{ 'clicked-btn-style': clickedTestcodeBtn == existTestcode.testcode[index], 'btn-style': clickedTestcodeBtn != existTestcode.testcode[index] }"
                      style="margin-right: 10px;">{{ existTestcode.testcode[index] }}</button>
                    <div style="margin-right: 10px;">:</div>
                    <div>{{ tagItem }}</div>
                  </div>
                </div>
                <div>
                  <button class="btn-style" @click="clickExport">Export</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div style="margin-top: 20px; overflow: auto;">
        <h3>Video List</h3>
        <div v-for="item in videoFromTag" :key="item">
          {{ item }}
        </div>
      </div>
    </div>
  </div>
  <div class="footer">
    <p>Copyright © 2024 Pi:Lab, SMU. All rights reserved.</p>
    <p>help@pilab.smu.ac.kr</p>
  </div>
</template>

<script>
import axios from 'axios'
export default {
  name: 'videoUploadPage',
  data() {
    return {
      isClicked: [],
      menuBar: ['Home'],
      baseUrl: process.env.BASE_URL + "api/",
      tag: [],
      clickedTagBtn: [],
      clickedTestcodeBtn: "",
      testcode: '',
      existTestcode: [],
      // click된 video list 
      videoFromTag: [],
      isTestcodeClicked: false,
      isSelectedAll: false,
      tagLengthOfTestcode: 0,
    }
  },
  mounted() {
    this.getTag();
    this.getTestcodeWithTag();
  },
  methods: {
    // TODO: tag를 누르면 거기에 있는 data list 이름이 보이게 만들기
    // ex) ALL 누르면 모든 비디오 영상이 나오고, bright 누르면 bright태그에 있는 모든 영상 리스트 보여주기 

    // TODO: 클릭은 되는데 videoList가 안 옴
    // TODO: tsetcode 버튼을 누르고 그냥 tag 버튼을 누르면 뻑 남
    clickExport() {
      console.log("clicked testcode: " + this.clickedTestcodeBtn);
      axios
        .post(this.baseUrl + 'exportVideo', {
          testcode: this.clickedTestcodeBtn
        })
        .then((response) => {
          console.log("response.data: " + response.data);
          console.log("response: " + response)
          // alert("Exported testcode: " + this.clickedTestcodeBtn);
          const url = window.URL.createObjectURL(new Blob([response.data]));
          const link = document.createElement('a');
          link.href = url;
          link.setAttribute('download', 'scoring_data.csv'); // 다운로드될 파일 이름
          document.body.appendChild(link);
          link.click();
        })
        .catch((error) => {
          console.log(error);
        })
    },
    clickTestcodeBtn(testcodeName) {
      if (this.clickedTestcodeBtn == testcodeName) {
        this.clickedTestcodeBtn = "";
      } else {
        this.isTestcodeClicked = true;
        this.clickedTestcodeBtn = testcodeName;
      }

      const testcodeIndex = this.existTestcode.testcode.indexOf(testcodeName);
      // if (testcodeIndex !== -1) {
      //   for (var i = 0; i < this.tag.length; i++) {
      //     this.clickTagBtn(i);
      //   }
      // }
      if (testcodeIndex !== -1) {
        const tags = this.existTestcode.tags[testcodeIndex];
        tags.forEach(tag => {
          const tagIndex = this.tag.findIndex(item => item === tag);
          if (tagIndex !== -1) {
            this.clickTagBtn(tagIndex);
          }
        });
      }
      this.getVideoListFromTag();
    },
    async getVideoListFromTag() {
      this.videoFromTag = [];
      if (this.clickedTagBtn.length === 0) {
        //console.log("There are no clicked tags");
        return;
      }
      await axios
        .get(this.baseUrl + 'getVideoListFromTag', {
          params: {
            tag: this.clickedTagBtn
          }
        })
        .then((response) => {
          // console.log("get video list from tag: " + response.data);
          this.videoFromTag = response.data;
        })
        .catch((error) => {
          console.log(error);
        })
    },
    selectAllTags() {
      if (this.tag.length === 0) {
        alert("There is no tag");
        return;
      }
      if (this.clickedTagBtn.length === this.tag.length) { // 이미 모든 태그가 선택되었을 경우
        this.clickedTagBtn = [];
        this.isClicked = this.tag.map(() => false);
        //console.log("clicked tag button: " + this.isClicked);
        this.$refs.tag.forEach((btn) => {
          btn.className = 'btn-style';
        });
        this.$refs.selectAllBtn.className = 'btn-style';
      } else { // 그렇지 않은 경우
        this.clickedTagBtn = [...this.tag];
        this.isClicked = this.tag.map(() => true);
        //console.log("clicked tag button: " + this.isClicked);
        this.$refs.tag.forEach((btn) => {
          btn.className = 'clicked-btn-style';
        });
        this.$refs.selectAllBtn.className = 'clicked-btn-style';
      }
      this.isSelectedAll = !this.isSelectedAll;
    },
    // 마우스가 버튼 위에 올라갔을 때
    mouseOver(index) {
      const tagName = this.tag[index];
      if (!this.clickedTagBtn.includes(tagName)) {
        this.$refs.tag[index].className = 'clicked-btn-style';
      }
    },
    // 마우스가 버튼에서 나갔을 때
    mouseOut(index) {
      const tagName = this.tag[index];
      if (!this.clickedTagBtn.includes(tagName)) {
        this.$refs.tag[index].className = 'btn-style';
      }
    },
    // tag 가져오는 method
    async getTag() {
      await axios
        .get(this.baseUrl + 'getTag')
        .then((response) => {
          //console.log(response.data);
          this.tag = response.data;
        })
        .catch((error) => {
          console.log(error);
        })
    },
    //     ressult := struct {
    // 	TestCode []string `json:"testcode"`
    // 	Tags     []string `json:"tags"`
    // }
    async getTestcodeWithTag() {
      await axios
        .get(this.baseUrl + 'getTestcodeWithTag')
        .then((response) => {
          //console.log(response.data);
          this.existTestcode = response.data;
          for (var i = 0; i < this.existTestcode.tags.length; i++) {
            this.existTestcode.tags[i] = this.existTestcode.tags[i].replace(/,/g, ', ')
          }
          //console.log("exist testcode tags: ", this.existTestcode.tags);
        })
        .catch((error) => {
          console.log(error);
        })
    },
    async generateTestcode() {
      if (this.clickedTagBtn == 0) {
        alert("Please choose tag");
        return;
      }
      await axios
        .post(this.baseUrl + 'generateTestcode', {
          tags: this.clickedTagBtn
        })
        .then((response) => {
          //console.log(response.data);
          // response가 -1 이면 이미 존재하는 testcode 
          if (response == -1) {
            //console.log("Aleread existing testcode");
            alert("Aleread existing testcode");
            return;
          }
          this.testcode = response.data;
          alert("Generated testcode: " + this.testcode);
          this.getTag();
          this.getTestcodeWithTag();
        })
        .catch((error) => {
          console.log(error);
        })
    },
    clickTagBtn(index) {
      if (this.isTestcodeClicked) {
        this.isTestcodeClicked = false;
        this.clickedTestcodeBtn = "";
      }
      if (this.isSelectedAll) {
        this.isSelectedAll = false;
      }
      const tagName = this.tag[index];
      //console.log("index: ", index)
      if (this.isClicked[index] == true) {
        for (var i = 0; i < this.clickedTagBtn.length; i++) {
          if (this.clickedTagBtn[i] === tagName) {
            this.$refs.tag[index].className = 'btn-style';
            this.clickedTagBtn.splice(i, 1);
            this.isClicked[index] = !this.isClicked[index];
            i--;
            //console.log("removed tag:", tagName);
            break;
          }
        }
      } else {
        // this.$refs['clickedTagBtn'+ index].className = 'btn btn-outline-primary';
        this.$refs.tag[index].className = 'clicked-btn-style';
        this.isClicked[index] = !this.isClicked[index];
        this.clickedTagBtn.push(tagName);
        //console.log("added tag:", tagName);
      }
      if (this.clickedTagBtn.length == this.tag.length) {
        this.isSelectedAll = true;
      }
    },
  },
}
</script>

<style lang="scss">
@import '../main.css';
@import url('https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500&display=swap');
</style>
